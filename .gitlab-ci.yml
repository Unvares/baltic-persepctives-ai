image: 'thlmylab/swakkd:stable'

stages:
- prepare
- build
- deploy
- expose

secrets:
    stage: prepare
    script:
    - kubectl delete secret gitlab-registry-$CI_PROJECT_ID || true
    - >
      kubectl create secret docker-registry gitlab-registry-$CI_PROJECT_ID
      --docker-server=$CI_REGISTRY
      --docker-username=image-registry
      --docker-password=$CI_REGISTRY_TOKEN

volumes:
  stage: prepare
  script:
  - cd deploy
  - kubectl apply -f demo-pvc.yaml

kira-ui-img:
  stage: build
  image: docker:24
  services: ["docker:24-dind"]
  only:
    changes:
    - kira-ui/*
    - kira-ui/*/**
    - .gitlab-ci.yml
  script:
  - cd kira-ui
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker build -t $CI_REGISTRY_IMAGE/kira:latest .
  - docker push $CI_REGISTRY_IMAGE/kira:latest

indexer-img:
  stage: build
  image: docker:24
  services: ["docker:24-dind"]
  only:
    changes:
    - indexer/*
    - indexer/*/**
    - .gitlab-ci.yml
  script:
  - cd indexer
  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  - docker build -t $CI_REGISTRY_IMAGE/indexer:latest .
  - docker push $CI_REGISTRY_IMAGE/indexer:latest

kira-ui:
  stage: deploy
  script:
  - cd deploy
  - mo kira-ui-dep+svc.yaml | kubectl delete -f - || true
  - mo kira-ui-dep+svc.yaml | kubectl apply -f -

indexer:
  stage: deploy
  script:
  - cd deploy
  - mo index-job.yaml | kubectl delete -f - || true
  - mo index-job.yaml | kubectl apply -f -

ingress:
    stage: expose
    script:
    - cd deploy
    - mo project-ing.yaml | kubectl apply -f -
